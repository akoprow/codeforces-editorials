Exercise says $$a_i \in [l_i, r_i]$$ but the intuition suggests that in the optimal solution we can always pick either $$l_i$$ or $$r_i$$.  How can we convince ourselves that's true?  Say we have $$a_i \in (l_i, r_i)$$.  Let's then count how many of the neighbours have values smaller/larger than $$a_i$$.  If there are more smaller neighbours then we'll get a better result by increasing $$a_i$$ so we might as well increase it all the way to $$r_i$$ (note that by doing so we might increase that imbalance even more).  Similarly for the symmetrical case when there are more larger neighbours, in which case $$l_i$$ is better.  What if those two sets are equal?  Moving to $$l_i$$ or $$r_i$$ will at either not make a difference (if we don't "cross" any of the other numbers by making this move) or improve the result (if we do cross at least one).

Now that we know that we only need to consider $$l_i$$ and $$r_i$$ let's root the tree at an arbitrary node and for all nodes $$u$$ we can calculate $$\mathcal{D}_{u,\leftarrow}$$ and $$\mathcal{D}_{u,\rightarrow}$$ which are the best results we can get for the subtree at $$u$$ picking $$l_i$$, respectively, $$r_i$$, for its value.  Then we do a DFS and calculate those values from leaves up to the root.  The respective equations are rather straightforward.  Clearly, the final answer is
$$max(\mathcal{D}_{r,\leftarrow}, \mathcal{D}_{r,\rightarrow})$$ where $$r$$ is the root we picked.
